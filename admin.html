<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Gizli Rapor • KontrolSende</title>
  <meta name="robots" content="noindex,nofollow"/>
  <link rel="stylesheet" href="css/style.css"/>
</head>
<body>
  <main class="container page-content page-bg">
    <h1>Gizli Rapor</h1>
    <div class="card">
      <p>Bu cihazdaki yerel sonuçları gösterir. (Merkezi toplama kurmadıysak sadece bu tarayıcıdaki veriler görünür.)</p>
      <div class="actions">
        <button class="btn" id="refresh">Yenile</button>
        <button class="btn" id="export">CSV indir</button>
        <button class="btn" id="clear">Tümünü temizle</button>
      </div>
    </div>

    <div id="summary" class="card"></div>
    <div id="items" class="grid-2"></div>
  </main>

  <script>
    function level(p){ return p<=33?'Düşük':(p<=66?'Orta':'Yüksek'); }
    function tone(p){ return p<=33?'good':(p<=66?'mid':'high'); }
    function getResults(){ try{ return JSON.parse(localStorage.getItem('ks-results')||'[]'); }catch(e){return [];} }

    const summaryEl=document.getElementById('summary');
    const itemsEl=document.getElementById('items');

    function render(){
      const list=getResults();
      itemsEl.innerHTML='';
      if(!list.length){ summaryEl.innerHTML='<p>Henüz kayıt yok.</p>'; return; }

      const avg=Math.round(list.reduce((a,b)=>a+b.totalPct,0)/list.length);
      summaryEl.innerHTML = `<p><strong>Toplam kayıt:</strong> ${list.length} • <strong>Genel ort:</strong> ${avg}% (${level(avg)})</p>`;

      itemsEl.innerHTML=list.map(it=>`
        <div class="card">
          <div class="history-head">
            <strong>${new Date(it.at).toLocaleString()}</strong>
            <span class="pill">Genel: ${it.totalPct}%</span>
          </div>
          ${it.cats.map(c=>`
            <div class="bar">
              <div class="bar-top"><span>${c.cat}</span><span>${c.pct}%</span></div>
              <div class="bar-bg"><div class="bar-fill ${tone(c.pct)}" style="width:${c.pct}%"></div></div>
            </div>
          `).join('')}
        </div>
      `).join('');
    }

    document.getElementById('refresh').addEventListener('click', render);
    document.getElementById('clear').addEventListener('click', ()=>{ if(confirm('Silinsin mi?')){ localStorage.removeItem('ks-results'); render(); }});
    document.getElementById('export').addEventListener('click', ()=>{
      const list=getResults(); if(!list.length) return alert('Kayıt yok.');
      const cats=Array.from(new Set(list.flatMap(x=>x.cats.map(c=>c.cat))));
      const rows=[['Tarih','Genel(%)',...cats.map(c=>`${c}(%)`)].join(',')];
      list.forEach(it=>{
        const map=Object.fromEntries(it.cats.map(c=>[c.cat,c.pct]));
        rows.push([it.at,it.totalPct,...cats.map(c=>map[c]??'')].join(','));
      });
      const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download='kontrolsende_rapor.csv'; a.click(); URL.revokeObjectURL(url);
    });

    render();
  </script>
</body>
</html>
