<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Paneli | KontrolSende</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <!-- 🔹 Navigasyon -->
  <nav class="container-fluid glass-nav">
    <ul>
      <li><strong>KontrolSende</strong></li>
    </ul>
    <ul>
      <li><a href="index.html">Ana Sayfa</a></li>
      <li><a href="test.html">Test</a></li>
      <li><a href="etkinlikler.html">Etkinlikler</a></li>
      <li><a href="yardim.html">Yardım</a></li>
      <li><a href="admin.html" class="active" role="button">Admin</a></li>
    </ul>
  </nav>

  <!-- 👨‍💼 Admin Panel İçeriği -->
  <main class="container">
    <section>
      <hgroup>
        <h2>Admin Paneli</h2>
        <h3>Test Sonuçlarını Görüntüle</h3>
      </hgroup>

      <p>
        Bu alan yalnızca yetkili kişiler tarafından kullanılmalıdır.  
        Test sonuçları, genel farkındalık istatistikleri ve kategori dağılımları burada listelenir.
      </p>

      <div id="statsContainer" style="display:none;">
        <h3>Genel Ortalama</h3>
        <p id="avgText"></p>
        <canvas id="chart" width="400" height="200"></canvas>

        <h3>Sonuç Listesi</h3>
        <table id="resultsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Toplam %</th>
              <th>Kategoriler</th>
              <th>Tarih</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="4">Veriler yükleniyor...</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- ⚙️ Altbilgi -->
  <footer class="container">
    <small>
      <a href="index.html">KontrolSende</a> • 
      <a href="https://unsplash.com" target="_blank">Görseller: Unsplash</a>
    </small>
  </footer>

  <script src="js/main.js"></script>
  <script>
    // PIN kontrolü
    document.addEventListener("DOMContentLoaded", () => {
      checkAdminAccess(); // main.js fonksiyonu
    });

    // Verileri çek ve tablo + grafik oluştur
    async function fetchResultsAndShowChart() {
      try {
        const res = await fetch("https://kontrolsende.onrender.com/getResults");
        const data = await res.json();
        renderResults(data);

        if (data.length) {
          document.getElementById("statsContainer").style.display = "block";
          const avgs = data.map(r => r.total_pct);
          const avgTotal = (avgs.reduce((a, b) => a + b, 0) / avgs.length).toFixed(1);
          document.getElementById("avgText").textContent = `Ortalama farkındalık: ${avgTotal}%`;

          // Basit grafik: toplam farkındalık eğrisi
          const ctx = document.getElementById("chart").getContext("2d");
          new Chart(ctx, {
            type: "line",
            data: {
              labels: data.map(r => `#${r.id}`),
              datasets: [{
                label: "Toplam Farkındalık %",
                data: data.map(r => r.total_pct),
                borderColor: "#00a978",
                fill: false,
                tension: 0.3
              }]
            },
            options: {
              scales: {
                y: { beginAtZero: true, max: 100 }
              }
            }
          });
        }
      } catch (err) {
        console.error("❌ Admin verisi hatası:", err);
      }
    }

    // Admin giriş kontrolü tamamlanınca tabloyu yükle
    async function checkAdminAccess() {
      const pin = prompt("Admin PIN kodunu giriniz:");
      if (pin !== "2468") {
        alert("Hatalı PIN! Ana sayfaya yönlendiriliyorsunuz.");
        window.location.href = "index.html";
      } else {
        await fetchResultsAndShowChart();
      }
    }
  </script>
</body>
</html>
