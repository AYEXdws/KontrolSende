<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KontrolSende • Admin Panel</title>
  <link rel="stylesheet" href="css/style.css?v=702">
</head>
<body class="theme-glass">

  <header class="ks-header">
    <div class="ks-container ks-nav">
      <a href="index.html" class="ks-logo">KontrolSende</a>
    </div>
  </header>

  <main class="ks-container" style="padding:40px 0">
    
    <!-- 🔐 Giriş Ekranı -->
    <section id="a-login" style="text-align:center;">
      <div class="admin-hero">
        <div class="admin-hero-icon">🔒</div>
        <h1>Admin Paneli</h1>
        <p class="muted">Lütfen PIN kodunu girin</p>
      </div>
      <div class="admin-login-row" style="justify-content:center;">
        <input id="a-pin" type="password" placeholder="PIN kodu" inputmode="numeric">
        <button id="a-enter" class="btn btn-primary" type="button">Giriş</button>
      </div>
    </section>

    <!-- 📊 Panel -->
    <section id="a-panel" style="display:none;">
      <h2>Yönetim Paneli</h2>

      <!-- Tabs -->
      <div class="tabs">
        <button id="tab-events" class="btn btn-primary">Etkinlikler</button>
        <button id="tab-results" class="btn ghost">Sonuçlar</button>
      </div>

      <!-- Etkinlikler -->
      <div id="events-panel">
        <div class="event-form">
          <input id="event-title" placeholder="Başlık">
          <input id="event-desc" placeholder="Açıklama">
          <input id="event-img" placeholder="Görsel URL">
          <input id="event-video" placeholder="Video URL (opsiyonel)">
          <button id="add-event" class="btn btn-primary" type="button">Ekle</button>
        </div>
        <div id="admin-event-list"></div>
      </div>

      <!-- Sonuçlar -->
      <div id="results-panel" style="display:none;">
        <div id="admin-result-list"></div>
      </div>
    </section>

  </main>

  <footer class="site-footer">
    <div class="ks-container foot">
      <span class="muted small">© 2025 KontrolSende</span>
    </div>
  </footer>

  <!-- ⚙️ Admin JS -->
  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    const PIN = "29391354";
    const loginBox = document.getElementById("a-login");
    const panelBox = document.getElementById("a-panel");
    const pinIn = document.getElementById("a-pin");
    const enterBtn = document.getElementById("a-enter");

    // 🔐 PIN kontrol
    enterBtn.addEventListener("click", () => {
      const val = (pinIn.value || "").trim();
      if (val !== PIN) return alert("Hatalı PIN");
      loginBox.style.display = "none";
      panelBox.style.display = "block";
      renderAdminEvents();
      renderAdminResults();
    });

    // Tab geçişleri
    const tabEvents = document.getElementById("tab-events");
    const tabResults = document.getElementById("tab-results");
    const eventsPanel = document.getElementById("events-panel");
    const resultsPanel = document.getElementById("results-panel");

    tabEvents.addEventListener("click", () => {
      tabEvents.classList.add("btn-primary"); tabResults.classList.remove("btn-primary"); tabResults.classList.add("ghost");
      eventsPanel.style.display = "block"; resultsPanel.style.display = "none";
      renderAdminEvents();
    });

    tabResults.addEventListener("click", () => {
      tabResults.classList.add("btn-primary"); tabEvents.classList.remove("btn-primary"); tabEvents.classList.add("ghost");
      eventsPanel.style.display = "none"; resultsPanel.style.display = "block";
      renderAdminResults();
    });

    // ✅ Etkinlik ekleme
    document.getElementById("add-event").addEventListener("click", async () => {
  const title = document.getElementById("event-title").value.trim();
  const desc  = document.getElementById("event-desc").value.trim();
  const img   = document.getElementById("event-img").value.trim();
  const video = document.getElementById("event-video").value.trim();

  if (!title) return alert("Başlık gerekli.");
  // img ya da video’dan en az biri olsa güzel olur ama zorunlu değil.

  await fetch("https://kontrolsende-api.onrender.com/addEvent",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ title, desc, img, video })
  });
  alert("Etkinlik eklendi ✅");
  renderAdminEvents();
});
    // ✅ Etkinlikleri getir
    async function renderAdminEvents() {
      const wrap = document.getElementById("admin-event-list");
      wrap.innerHTML = `<p class="muted">Yükleniyor...</p>`;
      const res = await fetch("https://kontrolsende-api.onrender.com/events");
      const events = await res.json();

      if (!events.length) {
        wrap.innerHTML = `<p class="muted">Henüz etkinlik yok.</p>`;
        return;
      }

      wrap.innerHTML = events.map(ev => `
        <article class="event-card">
          <img src="${ev.img}" alt="${ev.title}">
          <h4>${ev.title}</h4>
          <p>${ev.desc || ''}</p>
          <button class="btn ghost" data-del="${ev.id}">Sil</button>
        </article>
      `).join('');

      wrap.querySelectorAll("[data-del]").forEach(btn => {
        btn.addEventListener("click", async () => {
          if (!confirm("Bu etkinliği silmek istediğine emin misin?")) return;
          await fetch("https://kontrolsende-api.onrender.com/deleteEvent", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: btn.dataset.del }),
          });
          renderAdminEvents();
        });
      });
    }

    // ✅ Sonuçları getir
    async function renderAdminResults() {
      const wrap = document.getElementById("admin-result-list");
      wrap.innerHTML = `<p class="muted">Yükleniyor...</p>`;
      const res = await fetch("https://kontrolsende-api.onrender.com/results");
      const results = await res.json();

      if (!results.length) {
        wrap.innerHTML = `<p class="muted">Henüz kayıtlı test sonucu yok.</p>`;
        return;
      }

      wrap.innerHTML = results.map(r => `
        <div class="history-item">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>${new Date(r.at).toLocaleString()}</strong>
            <span class="pill">Genel: ${r.total_pct}%</span>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            ${r.cats.map(c=>`<span class="pill">${c.cat}: ${c.pct}%</span>`).join('')}
          </div>
          <button class="btn ghost" data-id="${r.id}">Sil</button>
        </div>
      `).join('');

      wrap.querySelectorAll("[data-id]").forEach(btn => {
        btn.addEventListener("click", async () => {
          if (!confirm("Bu sonucu silmek istediğine emin misin?")) return;
          await fetch("https://kontrolsende-api.onrender.com/deleteResult", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: btn.dataset.id }),
          });
          renderAdminResults();
        });
      });
    }
  });
  </script>

</body>
</html>
